<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D8 - TV en Direct</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary-black:#000;--primary-white:#fff;--primary-red:#e50914;--accent-pink:#ff1744;--gradient-red:linear-gradient(135deg,#e50914,#ff1744);--shadow:0 4px 20px rgba(229,9,20,.3)}
        body{font-family:'Helvetica Neue',Arial,sans-serif;background:var(--primary-black);color:var(--primary-white);overflow-x:hidden;position:relative;min-height:100vh}
        .loading-screen{position:fixed;inset:0;background:#000;display:flex;justify-content:center;align-items:center;z-index:10000;transition:opacity .5s}
        .loading-screen.hide{opacity:0;pointer-events:none}
        .loader{width:60px;height:60px;border:3px solid transparent;border-top-color:var(--accent-pink);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}

        .header{position:fixed;top:0;width:100%;padding:20px 50px;background:linear-gradient(to bottom,rgba(0,0,0,.95),rgba(0,0,0,.7));z-index:1000;transition:all .3s;backdrop-filter:blur(10px)}
        .header.scrolled{background:rgba(0,0,0,.98);padding:15px 50px}
        .nav-container{display:flex;justify-content:space-between;align-items:center}
        .logo{height:50px;display:flex;align-items:center;gap:10px;font-size:36px;font-weight:bold;background:var(--gradient-red);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:logoGlow 3s infinite;cursor:pointer}
        .logo-img{height:50px;width:auto;filter:drop-shadow(0 0 10px rgba(229,9,20,.5));animation:logoGlow 3s infinite}
        @keyframes logoGlow{0%,100%{filter:brightness(1) drop-shadow(0 0 10px rgba(229,9,20,.5))}50%{filter:brightness(1.2) drop-shadow(0 0 20px rgba(229,9,20,.8))}}
        .nav-menu{display:flex;gap:30px;list-style:none}
        .nav-item{color:#ccc;cursor:pointer;transition:all .3s;position:relative;font-size:16px;padding:5px 10px;text-decoration:none}
        .nav-item:hover{color:white;transform:translateY(-2px)}
        .nav-item.active{color:var(--accent-pink)}
        .nav-item::after{content:'';position:absolute;bottom:-5px;left:0;width:0;height:2px;background:var(--gradient-red);transition:width .3s}
        .nav-item.active::after,.nav-item:hover::after{width:100%}
        .user-profile{display:flex;align-items:center;gap:10px;padding:8px 15px;background:rgba(255,255,255,.1);border-radius:25px;cursor:pointer;transition:all .3s}
        .user-profile:hover{background:rgba(229,9,20,.3)}
        .user-avatar{width:35px;height:35px;border-radius:50%;background:var(--gradient-red);display:flex;align-items:center;justify-content:center;font-weight:bold}

        .main-content{padding-top:100px;min-height:100vh;padding-bottom:100px}
        .tv-container{max-width:1400px;margin:0 auto;padding:20px}
        .page-title{font-size:36px;margin-bottom:30px;background:var(--gradient-red);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.8}}

        .channels-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:40px;animation:slideUp .8s}
        @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
        .channel-card{background:linear-gradient(135deg,rgba(255,255,255,.1),rgba(255,255,255,.05));border-radius:20px;overflow:hidden;cursor:pointer;transition:all .3s;position:relative;aspect-ratio:16/9;backdrop-filter:blur(10px);border:2px solid rgba(255,255,255,.1)}
        .channel-card:hover{transform:scale(1.05);box-shadow:0 10px 40px rgba(229,9,20,.4);border-color:var(--accent-pink)}
        .channel-card.active{border-color:var(--primary-red);box-shadow:0 10px 40px rgba(229,9,20,.6)}
        .channel-content{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;background:rgba(0,0,0,.3)}
        .channel-logo{font-size:48px;font-weight:bold;background:var(--gradient-red);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px}
        .channel-logo-img{height:60px;width:auto;margin-bottom:10px;filter:drop-shadow(0 2px 10px rgba(0,0,0,.5))}
        .channel-name{font-size:18px;font-weight:bold;margin-bottom:5px}
        .channel-program{font-size:14px;color:#ccc;text-align:center;padding:0 10px}
        .live-badge{position:absolute;top:15px;right:15px;background:var(--primary-red);padding:5px 15px;border-radius:20px;font-size:12px;font-weight:bold;animation:blink 2s infinite}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.7}}
        .play-icon{position:absolute;width:60px;height:60px;background:rgba(229,9,20,.9);border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .3s}
        .channel-card:hover .play-icon{opacity:1}
        .play-icon::before{content:'▶';color:white;font-size:24px;margin-left:5px}

        .epg-container{background:linear-gradient(135deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border-radius:20px;padding:30px;backdrop-filter:blur(10px);animation:fadeIn 1s .3s both}
        @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .epg-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .epg-title{font-size:24px;font-weight:bold}
        .epg-date{color:#ccc;font-size:14px}
        .epg-timeline{display:grid;grid-template-columns:100px 1fr;gap:10px;margin-bottom:20px}
        .epg-channel-label{background:rgba(229,9,20,.2);padding:10px;border-radius:10px;text-align:center;font-weight:bold}
        .epg-programs{display:flex;gap:10px;overflow-x:auto;padding-bottom:10px}
        .epg-programs::-webkit-scrollbar{height:6px}
        .epg-programs::-webkit-scrollbar-track{background:rgba(255,255,255,.1);border-radius:3px}
        .epg-programs::-webkit-scrollbar-thumb{background:var(--accent-pink);border-radius:3px}
        .epg-program{min-width:220px;background:rgba(255,255,255,.05);padding:15px;border-radius:10px;border-left:3px solid var(--accent-pink);cursor:pointer;transition:all .3s}
        .epg-program:hover{background:rgba(229,9,20,.2);transform:translateY(-2px)}
        .epg-program.current{background:rgba(229,9,20,.3);border-left-color:var(--primary-red)}
        .epg-time{font-size:12px;color:#ccc;margin-bottom:5px}
        .epg-program-title{font-weight:bold;margin-bottom:3px}
        .epg-program-desc{font-size:12px;color:#999}

        .player-modal{position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;justify-content:center;align-items:center;z-index:9999;animation:fadeIn .3s}
        .player-modal.active{display:flex}
        .player-container{width:90%;max-width:1280px;background:#000;border-radius:10px;overflow:hidden;box-shadow:0 10px 50px rgba(229,9,20,.5);position:relative}
        .player-header{padding:15px 20px;background:linear-gradient(135deg,rgba(229,9,20,.2),rgba(255,23,68,.2));display:flex;justify-content:space-between;align-items:center}
        .player-title{font-size:18px;font-weight:bold}
        .close-player{background:rgba(255,255,255,.1);border:none;color:white;padding:8px 20px;border-radius:20px;cursor:pointer;transition:all .3s;font-size:14px}
        .close-player:hover{background:var(--primary-red);transform:scale(1.05)}
        .player-iframe{width:100%;height:720px;border:none}

        .mobile-menu{display:none;position:fixed;left:0;right:0;bottom:0;background:rgba(0,0,0,.98);padding:10px 0;z-index:1000;backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,.1)}
        .mobile-nav{display:flex;justify-content:space-around;align-items:center}
        .mobile-nav-item{display:flex;flex-direction:column;align-items:center;color:#ccc;padding:10px;cursor:pointer;transition:all .3s;text-decoration:none}
        .mobile-nav-item.active{color:var(--accent-pink)}
        .nav-icon{width:24px;height:24px;margin-bottom:5px;fill:currentColor}
        .nav-label{font-size:10px}

        .toast{position:fixed;top:20px;right:-400px;background:linear-gradient(135deg,rgba(229,9,20,.9),rgba(255,23,68,.9));color:white;padding:15px 25px;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,.3);transition:right .3s;z-index:10001}
        .toast.show{right:20px}

        @media (max-width:768px){
            .header{padding:15px 20px}
            .nav-menu,.user-profile{display:none}
            .mobile-menu{display:block}
            .tv-container{padding:10px}
            .page-title{font-size:28px;margin-bottom:20px}
            .channels-grid{grid-template-columns:1fr;gap:15px}
            .channel-card{aspect-ratio:16/10}
            .epg-container{padding:20px 15px}
            .epg-timeline{grid-template-columns:80px 1fr}
            .epg-program{min-width:170px}
            .player-container{width:100%;border-radius:0}
            .player-iframe{height:300px}
            .logo{font-size:28px}
            .logo-img{height:40px}
        }
        @media (max-width:480px){
            .channels-grid{grid-template-columns:1fr}
            .player-iframe{height:250px}
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen"><div class="loader"></div></div>

    <header class="header" id="header">
        <div class="nav-container">
            <div class="logo">
                <img src="assets/img/D8.png" alt="D8" class="logo-img" style="height: 40px; width: auto;">
            </div>
            <nav>
                <ul class="nav-menu" id="navMenu">
                    <li><a href="index.html" class="nav-item" id="goHome">Accueil</a></li>
                    <li><a href="tv.html" class="nav-item active">TV</a></li>
                    <li><a href="#" class="nav-item">PROGRAMMES</a></li>
                    <li><a href="#" class="nav-item">D8+</a></li>
                </ul>
            </nav>
            <div class="user-profile" id="userProfile">
                <div class="user-avatar" id="userAvatar">U</div>
                <span id="userName">User</span>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="tv-container">
            <h1 class="page-title">TV en Direct</h1>

            <div class="channels-grid">
                <!-- D8 -->
                <div class="channel-card active" onclick="openPlayer('D8','https://player.kick.com/d8tv')">
                    <div class="channel-content">
                        <div class="live-badge">LIVE</div>
                        <div class="channel-logo">D8</div>
                        <div class="channel-name">D8</div>
                        <div class="channel-program" id="d8Program">Chargement...</div>
                        <div class="play-icon"></div>
                    </div>
                </div>

                <!-- D8 Sport -->
                <div class="channel-card" onclick="showComingSoon('D8 Sport')">
                    <div class="channel-content">
                        <div class="channel-logo">D8</div>
                        <div class="channel-name">D8 Sport</div>
                        <div class="channel-program">Bientôt disponible</div>
                        <div class="play-icon"></div>
                    </div>
                </div>

                <!-- D8 Cinema -->
                <div class="channel-card" onclick="showComingSoon('D8 Cinema')">
                    <div class="channel-content">
                        <div class="channel-logo">D8</div>
                        <div class="channel-name">D8 Cinema</div>
                        <div class="channel-program">Bientôt disponible</div>
                        <div class="play-icon"></div>
                    </div>
                </div>
            </div>

            <!-- EPG -->
            <div class="epg-container">
                <div class="epg-header">
                    <h2 class="epg-title">Guide des programmes</h2>
                    <div class="epg-date" id="currentDate">Aujourd'hui</div>
                </div>

                <div class="epg-timeline">
                    <div class="epg-channel-label">D8</div>
                    <div class="epg-programs" id="epgPrograms">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="player-modal" id="playerModal">
        <div class="player-container">
            <div class="player-header">
                <div class="player-title" id="playerTitle">D8 - Direct</div>
                <button class="close-player" onclick="closePlayer()">✕ Fermer</button>
            </div>
            <div id="playerContent"></div>
        </div>
    </div>

    <nav class="mobile-menu">
        <div class="mobile-nav">
            <a href="#" class="mobile-nav-item" id="goHomeMobile">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                <span class="nav-label">Accueil</span>
            </a>
            <a href="tv.html" class="mobile-nav-item active">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14z"/></svg>
                <span class="nav-label">TV</span>
            </a>
            <a href="#" class="mobile-nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8 12.5v-9l6 4.5-6 4.5z"/></svg>
                <span class="nav-label">Programmes</span>
            </a>
            <a href="#" class="mobile-nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
                <span class="nav-label">D8+</span>
            </a>
        </div>
    </nav>

    <div class="toast" id="toast"></div>

    <!-- Include User Manager -->
    <script src="assets/js/user-manager.js"></script>
    <script>
        // In-memory state - now integrated with userManager
        let appState = { user: null, language: 'fr', currentChannel: 'D8' };

        // EPG data (requested schedule)
        const EPG = [
            { start: '17:00', end: '19:00', title: 'LOSC - Lyon', desc: 'Ligue 1, direct' },
            { start: '19:00', end: '20:30', title: '(En différé) Barcelone - Real Sociedad', desc: 'Rediffusion' },
            { start: '20:30', end: '20:40', title: 'LE JT', desc: 'Journal télévisé' },
            { start: '20:40', end: '20:45', title: 'Météo', desc: 'Bulletin météo' },
            { start: '20:45', end: '22:45', title: 'Milan - Napoli', desc: 'Serie A, direct' },
            { start: '22:45', end: '23:45', title: 'AFTER ZE MATCH', desc: 'Débrief & analyses' },
            { start: '23:45', end: '23:50', title: 'Météo', desc: 'Bulletin météo' },
            { start: '00:00', end: null,  title: 'Fin des programmes', desc: '' }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => document.getElementById('loadingScreen').classList.add('hide'), 1200);

            // Initialize user manager and get user data
            userManager.initialize();
            const userData = userManager.getUser();

            if (userData && userData.username) {
                appState.user = userData;
                appState.language = userData.language || 'fr';

                // Update UI with user info
                document.getElementById('userName').textContent = userData.username;
                document.getElementById('userAvatar').textContent = userData.username.charAt(0).toUpperCase();
            } else {
                // Fallback for legacy URL parameter
                const params = new URLSearchParams(window.location.search);
                const username = params.get('user');
                if (username) {
                    const fallbackUser = {
                        username: decodeURIComponent(username),
                        language: 'fr',
                        settings: {}
                    };
                    userManager.saveUser(fallbackUser);
                    appState.user = fallbackUser;
                    document.getElementById('userName').textContent = fallbackUser.username;
                    document.getElementById('userAvatar').textContent = fallbackUser.username.charAt(0).toUpperCase();
                } else {
                    // Default user
                    document.getElementById('userName').textContent = 'Utilisateur';
                    document.getElementById('userAvatar').textContent = 'U';
                }
            }

            // Header scroll style
            window.addEventListener('scroll', () => {
                document.getElementById('header').classList.toggle('scrolled', window.scrollY > 50);
            });

            // Navigation handlers with user data preservation
            document.getElementById('goHome').addEventListener('click', (e) => {
                e.preventDefault();
                userManager.navigateToHome();
            });

            document.getElementById('goHomeMobile').addEventListener('click', (e) => {
                e.preventDefault();
                userManager.navigateToHome();
            });

            // Logo click handler
            const logoElement = document.querySelector('.logo');
            if (logoElement) {
                logoElement.addEventListener('click', () => {
                    userManager.navigateToHome();
                });
            }

            // Build EPG UI
            renderEPG();
            // Highlight current program + set channel teaser
            highlightCurrentProgram();
            // Update every minute
            setInterval(highlightCurrentProgram, 60000);
        });

        function goToHome() {
            userManager.navigateToHome();
        }

        function renderEPG() {
            const container = document.getElementById('epgPrograms');
            container.innerHTML = '';
            for (const p of EPG) {
                const div = document.createElement('div');
                div.className = 'epg-program';
                const endTxt = p.end ? ` - ${p.end}` : '';
                div.innerHTML = `
                    <div class="epg-time">${p.start}${endTxt}</div>
                    <div class="epg-program-title">${p.title}</div>
                    <div class="epg-program-desc">${p.desc}</div>
                `;
                container.appendChild(div);
            }
            // Date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('fr-FR', options);
        }

        function parseHM(hm) {
            const [h, m] = hm.split(':').map(Number);
            const d = new Date();
            d.setHours(h, m, 0, 0);
            // handle 00:00 as next day end for the last program
            return d;
        }

        function highlightCurrentProgram() {
            const now = new Date();

            // Determine current program index
            let currentIdx = -1;
            for (let i = 0; i < EPG.length; i++) {
                const s = parseHM(EPG[i].start);
                const e = EPG[i].end ? parseHM(EPG[i].end) : null;

                // If end is null, consider it until 06:00 next day to avoid weirdness
                let inSlot = false;
                if (e) {
                    inSlot = now >= s && now < e;
                } else {
                    // Fin des programmes from 00:00 to 06:00
                    const endGuard = new Date(s); endGuard.setHours(6, 0, 0, 0);
                    inSlot = now >= s && now < endGuard;
                }

                if (inSlot) { currentIdx = i; break; }
            }

            // Clear / set classes
            document.querySelectorAll('.epg-program').forEach((el, idx) => {
                el.classList.toggle('current', idx === currentIdx);
            });

            // Update "teaser" under D8 card
            const teaser = document.getElementById('d8Program');
            if (currentIdx >= 0) {
                const p = EPG[currentIdx];
                teaser.textContent = `${p.title} - ${p.start}${p.end ? '→' + p.end : ''}`;
            } else {
                // If before 17:00, show first upcoming
                const p0 = EPG[0];
                teaser.textContent = `À ${p0.start} • ${p0.title}`;
            }
        }

        function openPlayer(channelName, streamUrl) {
            const modal = document.getElementById('playerModal');
            const playerContent = document.getElementById('playerContent');
            const playerTitle = document.getElementById('playerTitle');
            playerTitle.textContent = `${channelName} - Direct`;
            playerContent.innerHTML = `<iframe src="${streamUrl}" class="player-iframe" style="border:0;" allow="fullscreen"></iframe>`;
            modal.classList.add('active');
            showToast(`Lecture de ${channelName}`);
        }

        function closePlayer() {
            document.getElementById('playerContent').innerHTML = '';
            document.getElementById('playerModal').classList.remove('active');
        }

        function showComingSoon(name) {
            showToast(`${name} - Bientôt disponible`);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // Close modal on escape/background
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closePlayer();
        });

        document.getElementById('playerModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closePlayer();
        });
    </script>
</body>
</html>
